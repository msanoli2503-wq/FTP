---
- name: Configurar Servidor FTP Seguro (SSL + Usuarios + Jaulas)
  hosts: servidor
  become: yes
  vars:
    ssl_cert_path: /etc/ssl/certs/example.test.pem

  tasks:
    # ---------------------------------------------------------
    # 1. INSTALACIÓN
    # ---------------------------------------------------------
    - name: 1. Instalar vsftpd y openssl
      apt:
        name:
          - vsftpd
          - openssl
        state: present
        update_cache: yes

    # ---------------------------------------------------------
    # 2. CREACIÓN DE USUARIOS Y ARCHIVOS
    # ---------------------------------------------------------
    # USUARIO LUIS (Enjaulado)
    - name: 2.1 Crear usuario Luis
      user:
        name: luis
        password: "{{ 'luis' | password_hash('sha512') }}"
        shell: /bin/bash
        home: /home/luis
        state: present

    - name: 2.2 Crear archivos de prueba para Luis
      file:
        path: "/home/luis/{{ item }}"
        state: touch
        owner: luis
        group: luis
      loop:
        - luis1.txt
        - luis2.txt

    # USUARIO MARIA (NO Enjaulada)
    - name: 2.3 Crear usuario Maria
      user:
        name: maria
        password: "{{ 'maria' | password_hash('sha512') }}"
        shell: /bin/bash
        home: /home/maria
        state: present

    - name: 2.4 Crear archivos de prueba para Maria
      file:
        path: "/home/maria/{{ item }}"
        state: touch
        owner: maria
        group: maria
      loop:
        - maria1.txt
        - maria2.txt

    # USUARIO MIGUEL
    - name: 2.5 Crear usuario Miguel
      user:
        name: miguel
        password: "{{ 'miguel' | password_hash('sha512') }}"
        shell: /bin/bash
        state: present

    # ---------------------------------------------------------
    # 3. CERTIFICADO SSL
    # ---------------------------------------------------------
    - name: 3. Generar Certificado SSL (Solo si no existe)
      command: >
        openssl req -x509 -nodes -days 365 -newkey rsa:2048
        -keyout {{ ssl_cert_path }}
        -out {{ ssl_cert_path }}
        -subj "/C=ES/ST=Sevilla/L=Sevilla/O=IES/CN=ftp.example.test"
      args:
        creates: "{{ ssl_cert_path }}"

    # ---------------------------------------------------------
    # 4. CONFIGURACIÓN vsftpd.conf
    # ---------------------------------------------------------
    - name: 4. Copia de seguridad y crear vsftpd.conf
      copy:
        dest: /etc/vsftpd.conf
        backup: yes
        content: |
          # --- Configuración Base ---
          listen=YES
          listen_ipv6=NO
          ftpd_banner=--- Welcome to the FTP server of 'sistema.sol'---

          # --- Usuarios Anónimos ---
          anonymous_enable=YES
          anon_root=/srv/ftp
          dirmessage_enable=YES
          no_anon_password=YES
          # Límites anónimos (2MB/s) y permisos
          anon_max_rate=2097152
          anon_upload_enable=NO
          anon_mkdir_write_enable=NO

          # --- Usuarios Locales ---
          local_enable=YES
          write_enable=YES
          local_umask=022
          # Límites locales (5MB/s)
          local_max_rate=5242880

          # --- Red y Timeouts ---
          connect_from_port_20=YES
          idle_session_timeout=720
          max_clients=15

          # --- JAULAS CHROOT (Enjaular a todos menos a la lista) ---
          chroot_local_user=YES
          chroot_list_enable=YES
          chroot_list_file=/etc/vsftpd.chroot_list
          allow_writeable_chroot=YES

          # --- SEGURIDAD SSL/TLS ---
          ssl_enable=YES
          rsa_cert_file={{ ssl_cert_path }}
          rsa_private_key_file={{ ssl_cert_path }}
          # Forzar cifrado a locales, opcional para anónimos
          force_local_logins_ssl=YES
          force_local_data_ssl=YES
          allow_anon_ssl=YES
          force_anon_logins_ssl=NO
          force_anon_data_ssl=NO
          ssl_tlsv1=YES
          ssl_sslv2=NO
          ssl_sslv3=YES
          require_ssl_reuse=NO

      notify: Reiniciar vsftpd

    # ---------------------------------------------------------
    # 5. EXCEPCIONES DE JAULA
    # ---------------------------------------------------------
    - name: 5. Añadir a Maria a la lista de NO enjaulados
      copy:
        dest: /etc/vsftpd.chroot_list
        content: "maria\n"
        force: yes

    # ---------------------------------------------------------
    # 6. EXTRAS (Mensaje y Archivo grande)
    # ---------------------------------------------------------
    - name: 6. Crear mensaje de bienvenida anónimo
      copy:
        dest: /srv/ftp/.message
        content: "---You have accessed the public directory server of 'sistema.sol'---"

    - name: 7. Crear archivo grande (50MB) para prueba de velocidad
      command: dd if=/dev/zero of=/srv/ftp/test_speed.img bs=1M count=50
      args:
        creates: /srv/ftp/test_speed.img

  handlers:
    - name: Reiniciar vsftpd
      service:
        name: vsftpd
        state: restarted